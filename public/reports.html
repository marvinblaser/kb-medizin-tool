<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rapports - KB Medizin Tool</title>
  <link rel="stylesheet" href="/css/tokens.css" />
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/forms.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/table.css" />
  <link rel="stylesheet" href="/css/pages.css" />
  <link rel="stylesheet" href="/css/utilities.css" />
  <link rel="stylesheet" href="/css/transitions.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Styles Onglets & Badges */
    .tabs-container { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid var(--border-color); overflow-x: auto; }
    .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-light); border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; }
    .tab-btn:hover { color: var(--color-primary); }
    .tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
    
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; }
    .status-draft { background: #e2e8f0; color: #475569; } 
    .status-pending { background: #ffedd5; color: #c2410c; } 
    .status-validated { background: #dcfce7; color: #15803d; } 
    .status-archived { background: #dbeafe; color: #1e40af; } 

    .rejection-alert { background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none; }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header"><h2>KB Medizin</h2></div>
      <nav class="sidebar-nav">
        <a href="/dashboard.html"><i class="fas fa-chart-line"></i><span>Tableau de bord</span></a>
        <a href="/clients.html"><i class="fas fa-users"></i><span>Clients</span></a>
        <a href="/checklists.html"><i class="fas fa-clipboard-check"></i><span>Checklists</span></a>
        <a href="/reports.html" class="active"><i class="fas fa-file-alt"></i><span>Rapports</span></a>
        <a href="/admin.html" id="admin-link" class="hidden"><i class="fas fa-cog"></i><span>Administration</span></a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info" id="user-info"></div>
        <button class="btn btn-secondary btn-sm" id="logout-btn" style="width: 100%"><i class="fas fa-sign-out-alt"></i>Déconnexion</button>
      </div>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1><i class="fas fa-file-alt"></i> Rapports</h1>
        <button class="btn btn-success" id="add-report-btn"><i class="fas fa-plus"></i> Nouveau rapport</button>
      </div>

      <div class="tabs-container">
        <button class="tab-btn active" id="tab-draft"><i class="fas fa-pencil-alt"></i> Brouillons</button>
        <button class="tab-btn" id="tab-pending"><i class="fas fa-clock"></i> En attente</button>
        <button class="tab-btn" id="tab-validated"><i class="fas fa-check-circle"></i> Validés</button>
        <button class="tab-btn" id="tab-archived"><i class="fas fa-archive"></i> Archivés</button>
      </div>

      <div class="table-controls">
        <div class="table-controls-row">
          <div class="search-box"><input type="text" id="global-search" placeholder="Rechercher..." /></div>
          <select id="filter-type">
            <option value="">Tous les types</option>
            <option value="Mise en marche">Mise en marche</option>
            <option value="Service d'entretien">Service d'entretien</option>
            <option value="Réparation">Réparation</option>
            <option value="Contrôle">Contrôle</option>
          </select>
          <button class="btn btn-secondary" id="clear-filters-btn"><i class="fas fa-times"></i></button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>N° Rapport</th><th>Type</th><th>Client</th><th>Date</th><th>Statut</th><th style="text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="reports-tbody">
              <tr><td colspan="6" style="text-align: center; padding: 40px"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Chargement...</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="pagination">
        <span class="pagination-info" id="pagination-info"></span>
        <div class="pagination-buttons">
          <button class="btn btn-secondary" id="prev-page"><i class="fas fa-chevron-left"></i></button>
          <button class="btn btn-secondary" id="next-page"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </main>
  </div>

  <div class="modal" id="report-modal">
    <div class="modal-content" style="max-width: 1200px">
      <div class="modal-header">
        <h2 id="report-modal-title"><i class="fas fa-file-alt"></i> Rapport</h2>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-secondary btn-sm" id="header-pdf-btn" style="display:none;" title="Voir le PDF"><i class="fas fa-file-pdf"></i> Voir PDF</button>
            <button class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
      </div>
      
      <div id="rejection-msg-box" class="rejection-alert">
          <strong><i class="fas fa-exclamation-circle"></i> Rapport refusé :</strong> <span id="rejection-reason-text"></span>
      </div>

      <div class="modal-body">
        <form id="report-form">
          <input type="hidden" id="report-id" />
          
          <div class="form-section" style="background:#f8fafc; padding:10px; border:1px solid #e2e8f0; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
             <div><strong>Statut :</strong> <span id="current-status-badge" class="status-badge status-draft">Brouillon</span></div>
             <div id="validator-info" style="font-size:0.9em; color:#64748b;"></div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Général</h3>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>Type de travaux *</label>
                <select id="report-type" required>
                  <option value="">-- Sélectionner --</option>
                  <option value="Mise en marche">Mise en marche</option>
                  <option value="Service d'entretien">Service d'entretien</option>
                  <option value="Montage">Montage</option>
                  <option value="Réparation">Réparation</option>
                  <option value="Contrôle">Contrôle</option>
                  <option value="Instruction">Instruction</option>
                  <option value="Réparation / Garantie">Réparation / Garantie</option>
                  <option value="Première validation">Première validation</option>
                  <option value="Re-validation">Re-validation</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Client</h3>
            <div class="form-group"><label>Client *</label><select id="client-select" required><option value="">-- Sélectionner --</option></select></div>
            <div class="form-row">
                <div class="form-group"><input type="text" id="cabinet-name" placeholder="Cabinet" required /></div>
                <div class="form-group"><input type="text" id="interlocutor" placeholder="Interlocuteur" /></div>
            </div>
            <div class="form-group"><input type="text" id="address" placeholder="Adresse" required /></div>
            <div class="form-row">
              <div class="form-group"><input type="text" id="postal-code" placeholder="NPA" /></div>
              <div class="form-group"><input type="text" id="city" placeholder="Ville" required /></div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Installation</h3>
            <div class="form-group"><div id="client-equipment-list" style="max-height: 150px; overflow-y: auto; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;"></div></div>
            <div class="form-group"><label>Texte affiché :</label><textarea id="installation-text" rows="2" style="width:100%; font-weight:bold;"></textarea></div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Détails Intervention</h3>
            <label>Intervenants</label>
            <div id="technicians-list"></div>
            <button type="button" class="btn btn-sm btn-secondary" id="add-technician-btn" style="margin-top:5px;"><i class="fas fa-plus"></i></button>
            
            <label style="margin-top:15px; display:block;">Travaux accomplis</label>
            <div id="work-list"></div>
            <button type="button" class="btn btn-sm btn-secondary" id="add-work-btn" style="margin-top:5px;"><i class="fas fa-plus"></i></button>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Matériel & Tests</h3>
            <label>Tests STK</label>
            <div id="stk-tests-list"></div>
            <button type="button" class="btn btn-sm btn-secondary" id="add-stk-test-btn" style="margin-top:5px;"><i class="fas fa-plus"></i></button>

            <label style="margin-top:15px; display:block;">Matériel utilisé</label>
            <div id="materials-list"></div>
            <button type="button" class="btn btn-sm btn-secondary" id="add-material-btn" style="margin-top:5px;"><i class="fas fa-plus"></i></button>
            <div style="text-align: right; margin-top: 5px; font-weight: bold;">Total Matériel: <span id="materials-total">0.00</span> CHF</div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Déplacement</h3>
            <div class="form-row">
              <div class="form-group" style="flex:2;"><label>Ville Départ</label><input type="text" id="travel-city" /></div>
              <div class="form-group"><label>Canton</label><select id="travel-canton"><option value="">--</option><option value="AG">AG</option><option value="BE">BE</option><option value="BL">BL</option><option value="BS">BS</option><option value="FR">FR</option><option value="GE">GE</option><option value="JU">JU</option><option value="LU">LU</option><option value="NE">NE</option><option value="SG">SG</option><option value="SO">SO</option><option value="SZ">SZ</option><option value="TG">TG</option><option value="TI">TI</option><option value="VD">VD</option><option value="VS">VS</option><option value="ZG">ZG</option><option value="ZH">ZH</option></select></div>
              <div class="form-group"><label>Prix</label><input type="number" id="travel-costs" step="0.01" /></div>
              <div class="form-group" style="padding-top:25px;"><label><input type="checkbox" id="travel-incl" /> Inclus</label></div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Clôture</h3>
            <div class="form-group"><label>Commentaires</label><textarea id="remarks" rows="2"></textarea></div>
            <div class="form-row">
              <div class="form-group"><label>Date Signature</label><input type="date" id="tech-signature-date" /></div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer" style="justify-content: space-between;">
        <button class="btn btn-secondary" onclick="closeReportModal()">Fermer</button>
        
        <button id="save-report-btn" style="display:none;">Save</button>
        
        <div id="workflow-buttons" style="display:flex; gap:10px;"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="reject-modal">
      <div class="modal-content" style="max-width:500px">
          <div class="modal-header"><h3>Motif du refus</h3><button class="modal-close" onclick="document.getElementById('reject-modal').classList.remove('active')">&times;</button></div>
          <div class="modal-body">
              <textarea id="reject-reason" rows="4" style="width:100%; padding:10px;" placeholder="Raison..."></textarea>
          </div>
          <div class="modal-footer"><button class="btn btn-danger" id="confirm-reject-btn">Confirmer</button></div>
      </div>
  </div>
  
  <div class="modal" id="delete-modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Supprimer</h2><button class="modal-close" onclick="closeDeleteModal()">&times;</button></div>
      <div class="modal-body"><p>Voulez-vous vraiment supprimer ce rapport ?</p></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-delete-btn">Annuler</button>
        <button class="btn btn-danger" id="confirm-delete-btn">Supprimer</button>
      </div>
    </div>
  </div>

  <div id="notification-container" class="notification-container"></div>
  <script src="/js/reports.js"></script>
</body>
</html>