<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport de Service</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --border-black: 1px solid #000;
            --header-blue: #dae3f3; /* Bleu exact de la capture */
            --kb-red: #e30613;
            --kb-blue: #2e528f; /* Bleu du logo KB */
            --font-main: Arial, Helvetica, sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        body {
            margin: 0; padding: 20px; background: #555;
            font-family: var(--font-main); font-size: 11pt; /* Taille police ajustée */
            color: #000;
        }

        @page { size: A4; margin: 0; }

        .page-container {
            width: 210mm; min-height: 297mm;
            background: white; margin: 0 auto;
            padding: 10mm; position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        /* --- STRUCTURE GLOBALE --- */
        .main-border {
            border: 2px solid #000; /* Cadre extérieur épais */
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        .header { display: flex; height: 85px; border-bottom: 1px solid #000; }
        .logo-section {
            width: 45%; 
            display: flex; align-items: center; padding-left: 10px;
        }
        /* Simulation Logo Texte si image pas chargée, sinon l'image prend le dessus */
        .logo-text { font-size: 42px; font-weight: 900; color: var(--kb-blue); font-family: Arial, sans-serif; letter-spacing: -1px; }
        .logo-plus { background: var(--kb-red); color: white; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; font-size: 30px; margin-left: 5px; margin-bottom: 10px; font-weight: bold;}

        .title-section {
            width: 55%; background-color: var(--header-blue);
            border-left: 1px solid #000;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-weight: bold; font-size: 16px; line-height: 1.2;
        }

        /* --- INFO CLIENT --- */
        .client-section { padding: 5px 10px; font-size: 12px; line-height: 1.5; border-bottom: 1px solid #000;}
        .info-row { display: flex; }
        .info-label { width: 100px; }
        .info-value { font-weight: bold; flex: 1; outline: none; }

        /* --- CHECKBOXES (TRAVAUX) --- */
        .tasks-section { 
            border-bottom: 1px solid #000; padding: 5px 10px; font-size: 11px;
            display: flex; 
        }
        .tasks-label { width: 80px; padding-top: 2px;}
        .tasks-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr 1fr; row-gap: 2px; }
        .cb-item { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .cb-box { 
            width: 14px; height: 14px; border: 1px solid #000; background: #fff; 
            display: inline-block; position: relative;
        }
        .cb-box.checked { background: #000; }

        /* --- INSTALLATION --- */
        .install-section {
            border-bottom: 1px solid #000; padding: 4px 10px; font-weight: bold; font-size: 12px;
            display: flex;
        }

        /* --- TABLEAU INTERVENANTS --- */
        .tech-table {
            width: 100%; border-collapse: collapse; font-size: 11px;
        }
        .tech-table th, .tech-table td {
            border: 1px solid #000; padding: 2px; text-align: center;
            height: 18px;
        }
        .tech-table th { font-weight: normal; }
        .tech-table .col-name { width: 180px; text-align: left; padding-left: 5px; }
        .tech-table .col-day { width: 25px; }
        .tech-table .col-hours { width: 80px; }
        /* Bordure haut manquante car collée à la section précédente, on laisse le border-bottom de la section précédente gérer */
        .tech-table tr:first-child th { border-top: none; }
        .tech-table tr:first-child th:first-child { border-left: none; }
        .tech-table tr:first-child th:last-child { border-right: none; }

        /* --- SECTION LIGNÉE (Travaux & Matériel) --- */
        /* C'est ici que la magie opère pour les lignes verticales */
        .grid-row { display: flex; border-bottom: 1px solid #000; min-height: 20px; font-size: 11px; }
        .grid-row:last-child { border-bottom: none; }
        
        /* Colonnes fixes pour alignement vertical parfait */
        .col-qty { width: 40px; border-right: 1px solid #000; padding: 2px 5px; text-align: center; }
        .col-main { flex: 1; border-right: 1px solid #000; padding: 2px 5px; overflow: hidden; white-space: nowrap;}
        .col-price { width: 90px; border-right: 1px solid #000; padding: 2px 5px; text-align: right; }
        .col-incl { width: 60px; padding: 2px 5px; text-align: center; }

        .section-header { text-decoration: underline; font-weight: bold; margin-bottom: 2px; display: block;}
        
        /* --- TOTAL --- */
        .total-section {
            border-top: 2px solid #000; /* Trait épais */
            display: flex; font-weight: bold; font-size: 12px; height: 26px; align-items: center;
        }
        .total-lbl { flex: 1; padding-left: 10px; }
        .total-vat { padding-right: 10px; font-weight: normal; font-size: 10px; text-align: right; }
        .total-val { width: 60px; text-align: right; padding-right: 5px; font-size: 13px;}

        /* --- COMMENTAIRES --- */
        .comments-box {
            border-top: 1px solid #000; height: 100px; padding: 5px 10px; font-size: 12px;
        }

        /* --- SIGNATURES --- */
        .footer-sigs { margin-top: 40px; display: flex; justify-content: space-between; padding: 0 50px; font-size: 12px;}
        .sig-block { text-align: center; width: 200px; }
        .sig-line { margin-top: 10px; }

        /* Letter A bottom */
        .page-letter {
            text-align: center; margin-top: 40px; font-weight: bold; font-size: 14px;
        }

        /* --- BOUTON SAVE --- */
        .fab-save {
            position: fixed; bottom: 30px; right: 30px;
            background: #28a745; color: white; border: none; border-radius: 50px;
            padding: 15px 25px; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; z-index: 100; display: flex; align-items: center; gap: 10px;
        }

        @media print {
            body { background: white; padding: 0; }
            .page-container { box-shadow: none; margin: 0; width: 100%; height: 100%; }
            .fab-save { display: none; }
            [contenteditable] { background: none !important; }
        }
    </style>
</head>
<body>

    <button class="fab-save" onclick="saveReport()">
        <i class="fas fa-save"></i> Enregistrer
    </button>

    <div class="page-container">
        <div class="main-border">
            
            <div class="header">
                <div class="logo-section">
                    <img src="./src/images/logo-kbmed-short.svg" alt="KB Med" style="height: 55px; max-width: 100%;">
                </div>
                <div class="title-section">
                    Rapport de service<br>d'entretien
                </div>
            </div>

            <div class="client-section">
                <div class="info-row"><span class="info-label">Nom :</span> <span class="info-value" id="cabinet-name" contenteditable="true"></span></div>
                <div class="info-row"><span class="info-label">Adresse :</span> <span class="info-value" id="client-address" contenteditable="true"></span></div>
                <div class="info-row"><span class="info-label">Lieu :</span> <span class="info-value" id="client-city" contenteditable="true"></span></div>
                <div class="info-row"><span class="info-label">Interlocuteur :</span> <span class="info-value" id="interlocutor" contenteditable="true"></span></div>
            </div>

            <div class="tasks-section">
                <div class="tasks-label">Travaux :</div>
                <div class="tasks-grid">
                    <div class="cb-item" onclick="toggleCb(this)"><span class="cb-box" id="cb-Mise en marche"></span> Mise en marche</div>
                    <div class="cb-item" onclick="toggleCb(this)"><span class="cb-box" id="cb-Réparation"></span> Réparation</div>
                    <div class="cb-item" onclick="toggleCb(this)"><span class="cb-box" id="cb-Réparation / Garantie"></span> Réparation / Garantie</div>
                    
                    <div class="cb-item" onclick="toggleCb(this)"><span class="cb-box" id="cb-Service d'entretien"></span> Service d'entretien</div>
                    <div class="cb-item" onclick="toggleCb(this)"><span class="cb-box" id="cb-Contrôle"></span> Contrôle</div>
                    <div class="cb-item" onclick="toggleCb(this)"><span class="cb-box" id="cb-Première validation"></span> Première validation</div>
                    
                    <div class="cb-item" onclick="toggleCb(this)"><span class="cb-box" id="cb-Montage"></span> Montage</div>
                    <div class="cb-item" onclick="toggleCb(this)"><span class="cb-box" id="cb-Instruction"></span> Instruction</div>
                    <div class="cb-item" onclick="toggleCb(this)"><span class="cb-box" id="cb-Re-validation"></span> Re-validation</div>
                </div>
            </div>

            <div class="install-section">
                <span style="width: 80px;">Installation :</span>
                <span id="installation" contenteditable="true" style="flex:1"></span>
            </div>

            <table class="tech-table">
                <thead>
                    <tr>
                        <th class="col-name">Intervenants :</th>
                        <th colspan="7">Du <span id="date-start" contenteditable="true" style="font-weight:bold"></span> Au <span id="date-end" contenteditable="true" style="font-weight:bold"></span></th>
                        <th class="col-hours">Heures norm.</th>
                        <th class="col-hours">Heures sup.</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th class="col-day">Mo</th> <th class="col-day">Di</th> <th class="col-day">Mi</th> <th class="col-day">Do</th>
                        <th class="col-day">Fr</th> <th class="col-day">Sa</th> <th class="col-day">So</th>
                        <th></th><th></th>
                    </tr>
                </thead>
                <tbody id="tech-rows">
                    </tbody>
                <tfoot>
                    <tr style="font-weight: bold;">
                        <td style="text-align: left; padding-left: 5px;">TOTAL</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                        <td id="total-hours-norm">0.00</td>
                        <td id="total-hours-extra"></td>
                    </tr>
                </tfoot>
            </table>

            <div class="grid-row" style="height: 5px;"></div>

            <div style="border-top: 1px solid #000;">
                <div class="grid-row" style="border-bottom: 1px solid #000;">
                    <div class="col-qty" style="border:none"></div>
                    <div class="col-main" style="border:none"><span class="section-header">Travaux réalisés :</span></div>
                    <div class="col-price" style="border:none"></div>
                    <div class="col-incl" style="border:none"></div>
                </div>
                
                <div id="work-lines-container">
                    </div>

                <div id="stk-lines-container">
                    </div>
            </div>

            <div style="border-top: 1px solid #000;">
                <div class="grid-row" style="border-bottom: 1px solid #000;">
                    <div class="col-qty" style="border:none"></div>
                    <div class="col-main" style="border:none"><span class="section-header">Matériel utilisé :</span></div>
                    <div class="col-price" style="border:none"></div>
                    <div class="col-incl" style="border:none"></div>
                </div>

                <div id="material-rows-container">
                    </div>
            </div>

            <div class="grid-row" style="border-top: 1px solid #000;">
                <div class="col-qty" style="border-right: 1px solid #000"></div>
                <div class="col-main" style="font-weight: bold;">Frais de déplacement : <span id="travel-location" contenteditable="true" style="font-weight:normal; margin-left:10px"></span></div>
                <div class="col-price" id="travel-price" contenteditable="true"></div>
                <div class="col-incl" id="travel-incl"></div>
            </div>

            <div class="total-section">
                <div class="total-lbl">TOTAL</div>
                <div class="total-vat">Exkl. MWST</div>
                <div class="total-val" id="grand-total">0.00</div>
            </div>

            <div class="comments-box">
                Commentaires :
                <div id="remarks" contenteditable="true" style="outline:none; margin-top:5px;"></div>
            </div>

        </div> <div class="footer-sigs">
            <div class="sig-block">
                <div>Date : <span id="sig-date-tech" contenteditable="true"></span></div>
                <div class="sig-line">Signature de l’intervenant :</div>
                <div id="sig-tech" contenteditable="true" style="margin-top:20px; font-weight:bold; font-size:14px"></div>
            </div>
            <div class="sig-block">
                <div>Date : <span id="sig-date-client" contenteditable="true"></span></div>
                <div class="sig-line">Signature du client :</div>
            </div>
        </div>

    </div>

    <script src="/js/report-view.js"></script>
    <script>
        // Surcharge spécifique pour l'affichage des lignes vides avec bordures verticales
        
        // Fonction utilitaire pour générer une ligne Grid
        function renderGridRow(qty, text, price, incl, isEditable=true) {
            return `
            <div class="grid-row">
                <div class="col-qty" ${isEditable ? 'contenteditable="true"' : ''}>${qty || ''}</div>
                <div class="col-main" ${isEditable ? 'contenteditable="true"' : ''}>${text || ''}</div>
                <div class="col-price" ${isEditable ? 'contenteditable="true"' : ''}>${price || ''}</div>
                <div class="col-incl">${incl || ''}</div>
            </div>`;
        }

        // On réécrit une partie de loadReportData du fichier JS principal pour coller au HTML spécifique
        // Mais comme tu as déjà le fichier JS, je te conseille d'ajouter ceci à la fin de ton fichier /js/report-view.js
        // Ou mieux : remplace la logique de remplissage des lignes dans report-view.js par ceci :
        
        /* MODIFICATIONS A FAIRE DANS LE FICHIER JS POUR LE RENDU :
           Au lieu d'utiliser .line-row générique, utilise la structure .grid-row définie ci-dessus.
           
           Exemple pour Travaux :
           const container = document.getElementById('work-lines-container');
           container.innerHTML = '';
           lines.forEach(line => {
               container.innerHTML += renderGridRow('', line, '', '');
           });
           // Remplir jusqu'à 3 lignes min
           while(container.children.length < 3) container.innerHTML += renderGridRow('', '', '', '');
        */
    </script>
</body>
</html>