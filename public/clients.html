<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clients ERP - KB Medizin Tool</title>
  <link rel="stylesheet" href="/css/tokens.css" />
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/forms.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/table.css" />
  <link rel="stylesheet" href="/css/pages.css" />
  <link rel="stylesheet" href="/css/utilities.css" />
  <link rel="stylesheet" href="/css/transitions.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header"><h2>KB Medizin</h2></div>
      <nav class="sidebar-nav">
        <a href="/dashboard.html"><i class="fas fa-chart-line"></i><span>Tableau de bord</span></a>
        <a href="/clients.html" class="active"><i class="fas fa-users"></i><span>Clients</span></a>
        <a href="/checklists.html"><i class="fas fa-clipboard-check"></i><span>Checklists</span></a>
        <a href="/reports.html"><i class="fas fa-file-alt"></i><span>Rapports</span></a>
        <a href="/admin.html" id="admin-link" class="hidden"><i class="fas fa-cog"></i><span>Administration</span></a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info" id="user-info"></div>
        <button class="btn btn-secondary btn-sm" id="logout-btn" style="width: 100%">
          <i class="fas fa-sign-out-alt"></i> Déconnexion
        </button>
      </div>
    </aside>

    <main class="main-content">
      
      <div class="page-header">
        <div class="header-title-group">
            <h1><i class="fas fa-building"></i> Répertoire Clients</h1>
        </div>
        <div class="header-actions-group">
            <button class="btn btn-secondary" onclick="exportData()" title="Exporter">
                <i class="fas fa-file-export"></i>
            </button>
            <button class="btn btn-primary" onclick="openClientModal()">
                <i class="fas fa-plus"></i> Nouveau Client
            </button>
        </div>
      </div>

      <div class="client-container-fluid">
        
        <div class="toolbar-clean-bar">
            
            <div class="toolbar-search-section">
                <i class="fas fa-search"></i>
                <input type="text" id="global-search" placeholder="Rechercher un client, une ville..." />
            </div>

            <div class="toolbar-divider"></div>

            <div class="toolbar-nav-section">
                <button class="nav-text-btn active" onclick="switchView('directory')" id="tab-directory">
                    Annuaire
                </button>
                <button class="nav-text-btn" onclick="switchView('planning')" id="tab-planning">
                    Planning Services
                </button>
            </div>

            <div style="flex: 1;"></div> <div class="toolbar-filters-section">
                <select id="filter-canton" class="minimal-select">
                    <option value="">Canton (Tous)</option>
                    <option value="VD">Vaud</option><option value="GE">Genève</option><option value="VS">Valais</option><option value="NE">Neuchâtel</option><option value="FR">Fribourg</option><option value="JU">Jura</option><option value="BE">Berne</option><option value="ZH">Zurich</option>
                </select>
                
                <select id="filter-sector" class="minimal-select">
                    <option value="">Secteur (Tous)</option>
                    <option value="ORL">ORL</option><option value="Gynécologie">Gynécologie</option><option value="Stérilisation">Stérilisation</option>
                </select>

                <button class="btn-icon-simple" id="toggle-advanced-filters" title="Filtres avancés">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>
        </div>

        <div id="advanced-filters-panel" class="filters-panel hidden">
            <div class="filters-grid">
                <div class="form-group mb-0"><label>Marque</label><input type="text" id="adv-brand" placeholder="Ex: Atmos"></div>
                <div class="form-group mb-0"><label>Modèle</label><input type="text" id="adv-model" placeholder="Ex: C31"></div>
                <div class="form-group mb-0"><label>N° Série</label><input type="text" id="adv-serial" placeholder="S/N..."></div>
                <div class="form-group mb-0"><label>Statut</label><select id="adv-status"><option value="">Tous</option><option value="expired">Expiré</option><option value="warning">Bientôt</option><option value="ok">À jour</option></select></div>
            </div>
            <div class="filters-footer">
                <button class="btn-link-reset" id="clear-filters">Effacer les filtres</button>
            </div>
        </div>

        <div id="view-directory" class="view-content active">
            <div class="erp-table-wrapper">
                <table class="erp-table" id="clients-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="handleSort('cabinet_name')" style="width:25%;">Client / Cabinet <i class="fas fa-sort"></i></th>
                            <th class="sortable" onclick="handleSort('city')" style="width:15%;">Localisation <i class="fas fa-sort"></i></th>
                            <th style="width:20%;">Contact</th>
                            <th style="width:25%;">Parc Machine</th>
                            <th class="sortable" onclick="handleSort('appointment_at')" style="width:10%;">RDV <i class="fas fa-sort"></i></th>
                            <th style="width:60px;"></th>
                        </tr>
                    </thead>
                    <tbody id="clients-tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-planning" class="view-content">
            <div class="erp-table-wrapper">
                <table class="erp-table planning-table" id="planning-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="handlePlanningSort('status')" style="width:100px;">État <i class="fas fa-sort"></i></th>
                            <th class="sortable" onclick="handlePlanningSort('cabinet_name')">Client <i class="fas fa-sort"></i></th>
                            <th class="sortable" onclick="handlePlanningSort('city')">Lieu <i class="fas fa-sort"></i></th>
                            <th class="sortable" onclick="handlePlanningSort('catalog_name')">Machine <i class="fas fa-sort"></i></th>
                            <th>Type</th>
                            <th class="sortable" onclick="handlePlanningSort('last_maintenance_date')">Dernière <i class="fas fa-sort"></i></th>
                            <th class="sortable" onclick="handlePlanningSort('next_maintenance_date')">Échéance <i class="fas fa-sort"></i></th>
                            <th style="text-align:right;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="planning-tbody"></tbody>
                </table>
            </div>
        </div>

        <div class="erp-pagination">
            <div id="pagination-info">Chargement...</div>
            <div class="pagination-controls">
                <button class="pg-btn" id="prev-page"><i class="fas fa-chevron-left"></i></button>
                <button class="pg-btn" id="next-page"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="pagination-limit">
                <select id="limit-select">
                    <option value="25">25 / page</option>
                    <option value="50">50 / page</option>
                    <option value="100">100 / page</option>
                </select>
            </div>
        </div>

      </div>
    </main>
  </div>

  <div class="modal" id="client-details-modal">
      <div class="modal-content client-sheet-modal">
          
          <div class="sheet-header">
              <div class="sheet-title-box">
                  <div class="sheet-icon-box"><i class="fas fa-hospital-user"></i></div>
                  <div>
                      <h2 id="sheet-name">Nom Cabinet</h2>
                      <div class="sheet-meta-tags">
                          <span id="sheet-category" class="meta-badge">SECTEUR</span>
                          <span class="meta-sep">•</span>
                          <span id="sheet-city-header">VILLE</span>
                      </div>
                  </div>
              </div>
              <div class="sheet-actions-row">
                  <button class="btn-sheet-action" onclick="openClientModal(currentClientId)">
                      <i class="fas fa-pen"></i> Modifier
                  </button>
                  <button class="btn-sheet-action btn-sheet-danger" onclick="openDeleteModal(currentClientId)">
                      <i class="fas fa-trash"></i>
                  </button>
                  <div class="v-sep"></div>
                  <button class="btn-sheet-close" onclick="closeClientDetailsModal()">
                      <i class="fas fa-times"></i>
                  </button>
              </div>
          </div>
          
          <div class="sheet-layout">
              <div class="sheet-sidebar">
                  <div class="info-group">
                      <label>COORDONNÉES</label>
                      <div class="info-line"><i class="fas fa-map-marker-alt"></i> <span id="sheet-address">-</span></div>
                      <div class="info-line"><i class="fas fa-phone"></i> <span id="sheet-phone">-</span></div>
                      <div class="info-line"><i class="fas fa-envelope"></i> <span id="sheet-email">-</span></div>
                      <div class="info-line"><i class="fas fa-user-md"></i> <strong id="sheet-contact">-</strong></div>
                  </div>
                  
                  <div class="info-group">
                      <label>GÉOLOCALISATION</label>
                      <div id="sheet-coords" class="geo-box">Non défini</div>
                  </div>

                  <div class="info-group">
                      <label>NOTES INTERNES</label>
                      <div id="sheet-notes" class="notes-box">Aucune note.</div>
                  </div>
              </div>

              <div class="sheet-content">
                  <div class="sheet-tabs">
                      <button class="sheet-tab active" onclick="switchSheetTab('equipment')">Parc Machines <span class="badge-count" id="count-eq">0</span></button>
                      <button class="sheet-tab" onclick="switchSheetTab('history')">Historique <span class="badge-count" id="count-hist">0</span></button>
                  </div>
                  
                  <div id="tab-equipment" class="tab-pane active">
                      <div class="pane-actions">
                          <h3>Équipements installés</h3>
                          <button class="btn btn-primary btn-sm" onclick="openEquipFormModal()">
                              <i class="fas fa-plus"></i> Ajouter
                          </button>
                      </div>
                      <div id="sheet-equipment-list" class="cards-grid"></div>
                  </div>

                  <div id="tab-history" class="tab-pane">
                      <div id="sheet-history-list" class="history-feed"></div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <div class="modal" id="client-modal">
      <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header"><h2>Édition Client</h2><button class="modal-close" onclick="closeClientModal()">&times;</button></div>
          <div class="modal-body">
              <form id="client-form">
                  <input type="hidden" id="client-id">
                  <div class="form-row">
                      <div class="form-group" style="flex:2"><label>Nom Cabinet *</label><input type="text" id="client-name" required></div>
                      <div class="form-group"><label>Secteur</label><select id="client-activity"><option value="ORL">ORL</option><option value="Gynécologie">Gynécologie</option><option value="Stérilisation">Stérilisation</option><option value="Autre">Autre</option></select></div>
                  </div>
                  <div class="form-row">
                      <div class="form-group"><label>Contact</label><input type="text" id="client-contact"></div>
                      <div class="form-group"><label>Téléphone</label><input type="text" id="client-phone"></div>
                      <div class="form-group"><label>Email</label><input type="email" id="client-email"></div>
                  </div>
                  <div class="form-group"><label>Adresse</label><input type="text" id="client-address" placeholder="Rue et numéro"></div>
                  <div class="form-row">
                      <div class="form-group"><label>NPA</label><input type="text" id="client-npa"></div>
                      <div class="form-group" style="flex:2"><label>Ville</label><input type="text" id="client-city"></div>
                      <div class="form-group"><label>Canton</label><input type="text" id="client-canton" style="text-transform:uppercase" maxlength="2"></div>
                  </div>
                  
                  <div class="gps-container">
                      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                          <label style="margin:0; font-size:0.8rem; font-weight:bold; color:#166534;">COORDONNÉES GPS</label>
                          <button type="button" id="btn-geo-search" class="btn-xs-geo">Détecter</button>
                      </div>
                      <div class="form-row">
                          <div class="form-group mb-0"><input type="number" id="client-lat" step="0.0000001" placeholder="Latitude"></div>
                          <div class="form-group mb-0"><input type="number" id="client-lon" step="0.0000001" placeholder="Longitude"></div>
                      </div>
                      <div id="geo-status" style="font-size:0.75rem; margin-top:5px; min-height:1rem;"></div>
                  </div>

                  <div class="form-group"><label>Notes</label><textarea id="client-notes" rows="2"></textarea></div>
              </form>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" onclick="closeClientModal()">Annuler</button><button class="btn btn-primary" onclick="saveClient()">Enregistrer</button></div>
      </div>
  </div>

  <div class="modal" id="equipment-form-modal">
      <div class="modal-content" style="max-width:600px;">
          <div class="modal-header"><h2>Machine</h2><button class="modal-close" onclick="closeEquipModal()">&times;</button></div>
          <div class="modal-body">
              <form id="equip-form">
                  <input type="hidden" id="equip-id">
                  <div class="form-group"><label>Modèle</label><select id="equip-select" required></select></div>
                  <div class="form-group"><label>N° Série</label><input type="text" id="equip-serial"></div>
                  <div class="form-row">
                      <div class="form-group"><label>Installé le</label><input type="date" id="equip-install"></div>
                      <div class="form-group"><label>Dernière Maint.</label><input type="date" id="equip-last"></div>
                  </div>
                  <div class="form-group"><label>Intervalle (Années)</label><select id="equip-interval"><option value="1">1 An</option><option value="2">2 Ans</option><option value="3">3 Ans</option></select></div>
              </form>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" onclick="closeEquipModal()">Annuler</button><button class="btn btn-primary" onclick="saveEquipment()">Sauvegarder</button></div>
      </div>
  </div>

  <div class="modal" id="delete-modal"><div class="modal-content"><div class="modal-header"><h2>Confirmer</h2></div><div class="modal-body"><p>Supprimer définitivement ?</p></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeDeleteModal()">Non</button><button class="btn btn-danger" id="confirm-delete-btn">Oui</button></div></div></div>
  <div id="notification-container"></div>

  <script src="/js/clients.js"></script>
</body>
</html>