<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clients ERP - KB Medizin Tool</title>
  <link rel="stylesheet" href="/css/tokens.css" />
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/forms.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/table.css" />
  <link rel="stylesheet" href="/css/pages.css" />
  <link rel="stylesheet" href="/css/utilities.css" />
  <link rel="stylesheet" href="/css/transitions.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="shortcut icon" href="src/images/swiss_flag.webp" type="image/x-icon">
  <link href="https://unpkg.com/slim-select@2.8.2/dist/slimselect.css" rel="stylesheet">
  
  <style>
    /* --- STYLES CLIENTS SPECIFIQUES --- */
    .client-container-fluid { 
        width: 100%; height: calc(100vh - 80px); display: flex; flex-direction: column; 
        padding: 1.5rem 3rem !important; overflow: hidden; 
    }

    /* BARRE D'OUTILS (Standardisée) */
    .toolbar-clean-bar {
        background: white; border: 1px solid var(--border-color); border-radius: 8px;
        padding: 0 1.5rem; display: flex; align-items: center; height: 64px;
        box-shadow: var(--shadow-sm); margin-bottom: 1.5rem; flex-shrink: 0; gap: 1.5rem;
    }
    
    .toolbar-search-section { display: flex; align-items: center; gap: 0.8rem; color: var(--neutral-400); flex: 0 0 320px; }
    .toolbar-search-section input { border: none; background: transparent; width: 100%; font-size: 0.95rem; outline: none; padding: 0; }
    .toolbar-divider { width: 1px; height: 32px; background: var(--border-color); }
    
    .toolbar-nav-section { display: flex; gap: 1.5rem; height: 100%; }
    .nav-text-btn {
        background: transparent; border: none; border-bottom: 3px solid transparent; height: 100%;
        display: flex; align-items: center; font-size: 0.95rem; font-weight: 500; color: var(--neutral-500);
        cursor: pointer; transition: all 0.2s; padding: 0 5px; margin-bottom: -1px;
    }
    .nav-text-btn:hover { color: var(--color-primary); }
    .nav-text-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); font-weight: 600; }

    /* FILTRES & BOUTONS */
    .toolbar-filters-section { display: flex; align-items: center; gap: 0.8rem; }
    .minimal-select {
        border: 1px solid var(--border-color); border-radius: 6px; padding: 0.4rem 2rem 0.4rem 0.8rem;
        font-size: 0.85rem; background-color: white; cursor: pointer; height: 36px; color: var(--neutral-700); font-weight: 500;
        outline: none; max-width: 160px;
    }
    
    /* Bouton Filtres Avancés (AGRANDI) */
    .btn-icon-simple {
        background: white; border: 1px solid var(--border-color); color: var(--neutral-500); cursor: pointer; border-radius: 6px; 
        height: 44px; width: 44px; /* Agrandissement */
        font-size: 1.1rem; /* Icône plus grande */
        display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .btn-icon-simple:hover { background: var(--neutral-50); color: var(--color-primary); border-color: var(--color-primary-light); }

    /* TABLEAUX ERP */
    .view-content { flex: 1; overflow: hidden; display: none; flex-direction: column; }
    .view-content.active { display: flex; }
    
    .erp-table-wrapper { 
        flex: 1; overflow: auto; border: 1px solid var(--border-color); border-radius: 8px; 
        background: white; box-shadow: var(--shadow-sm); 
    }
    .erp-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .erp-table thead { position: sticky; top: 0; z-index: 10; background: var(--neutral-50); }
    .erp-table th {
        color: var(--neutral-600); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;
        padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); text-align: left; white-space: nowrap; cursor: pointer;
    }
    .erp-table td { padding: 0.85rem 1.25rem; border-bottom: 1px solid var(--border-color-light); vertical-align: middle; font-size: 0.9rem; color: var(--neutral-800); }
    .erp-table tbody tr:hover { background: var(--neutral-50); }

    /* Lignes Planning (Code Couleur) */
    .row-ok td:first-child { border-left: 4px solid var(--color-success); }
    .row-warning { background: #fffbf0; } .row-warning td:first-child { border-left: 4px solid var(--color-warning); }
    .row-expired { background: #fff5f5; } .row-expired td:first-child { border-left: 4px solid var(--color-danger); }

    /* MODALE FICHE CLIENT (Sheet) */
    .client-sheet-modal {
        width: 95vw !important; max-width: 1200px !important; height: 90vh; display: flex; flex-direction: column; overflow: hidden; border-radius: 12px;
    }
    .sheet-header {
        padding: 1.5rem 2rem; background: white; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;
    }
    .sheet-title-box { display: flex; align-items: center; gap: 1.5rem; }
    .sheet-icon-box {
        width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; color: var(--color-primary); background: var(--color-primary-light);
    }
    .sheet-meta-tags { display: flex; gap: 0.5rem; margin-top: 0.4rem; color: var(--neutral-500); font-size: 0.9rem; align-items: center; }
    .meta-badge { background: var(--neutral-100); padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--neutral-600); }

    .sheet-layout { display: flex; flex: 1; overflow: hidden; }
    .sheet-sidebar { width: 320px; background: var(--neutral-50); border-right: 1px solid var(--border-color); padding: 2rem; overflow-y: auto; flex-shrink: 0; }
    .sheet-content { flex: 1; background: white; padding: 0; display: flex; flex-direction: column; overflow: hidden; }
    
    .sheet-tabs { display: flex; border-bottom: 1px solid var(--border-color); padding: 0 2rem; background: white; }
    .sheet-tab {
        background: transparent; border: none; padding: 1rem 0; margin-right: 2rem; font-weight: 600; color: var(--neutral-500); cursor: pointer;
        border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 0.9rem;
    }
    .sheet-tab:hover { color: var(--color-primary); }
    .sheet-tab.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
    .badge-count { background: var(--neutral-100); color: var(--neutral-600); padding: 1px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 6px; }

    .tab-pane { flex: 1; padding: 2rem; overflow-y: auto; display: none; }
    .tab-pane.active { display: block; }

    /* INFO SIDEBAR */
    .info-group { margin-bottom: 2rem; }
    .info-group label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--neutral-400); text-transform: uppercase; margin-bottom: 0.75rem; letter-spacing: 0.05em; }
    .info-line { display: flex; align-items: flex-start; gap: 0.75rem; font-size: 0.9rem; color: var(--neutral-700); margin-bottom: 0.6rem; line-height: 1.4; }
    .info-line i { color: var(--color-primary); width: 16px; margin-top: 3px; }
    .geo-box { background: #ecfdf5; color: #166534; border: 1px solid #bbf7d0; padding: 6px 10px; border-radius: 6px; font-family: monospace; display: inline-block; font-size: 0.8rem; }
    
    /* CARDS MACHINES */
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .eq-card-pro {
        background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem;
        display: flex; justify-content: space-between; align-items: start;
        border-left: 4px solid var(--border-color); transition: all 0.2s;
    }
    .eq-card-pro:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); border-color: var(--color-primary-light); }
    .eq-title { margin: 0 0 4px 0; font-size: 0.95rem; font-weight: 700; color: var(--neutral-800); }
    .eq-sub { margin: 0; font-size: 0.8rem; color: var(--neutral-500); }
    .eq-date { font-size: 0.75rem; font-weight: 600; margin-top: 8px; display: block; }

    /* FILTRES AVANCÉS */
    .filters-panel { background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem; margin-top: -1rem; box-shadow: var(--shadow-sm); }
    .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
    .btn-link-reset { background: none; border: none; color: var(--color-danger); font-size: 0.85rem; cursor: pointer; text-decoration: underline; margin-top: 1rem; display: block; margin-left: auto; }

    /* Pagination (Harmonisée) */
    .erp-pagination { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; margin-top: 0.5rem; }
    .pg-btn { width: 32px; height: 32px; border: 1px solid var(--border-color); background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--neutral-600); }
    .pg-btn:hover { background: var(--neutral-50); color: var(--color-primary); }
    .pg-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .history-feed { 
        display: flex; flex-direction: column; gap: 0; padding-left: 10px; margin-top: 1rem; 
    }
    
    .timeline-item { 
        position: relative; padding-left: 2.5rem; padding-bottom: 2rem; border-left: 2px solid var(--border-color-light); 
    }
    .timeline-item:last-child { border-left-color: transparent; padding-bottom: 0; }
    
    .timeline-machine {
        display: inline-flex; align-items: center; gap: 6px;
        background: var(--neutral-50); color: var(--neutral-700);
        border: 1px solid var(--border-color);
        padding: 4px 10px; border-radius: 6px; 
        font-size: 0.8rem; font-weight: 500; font-family: var(--font-mono);
        margin-bottom: 0.75rem; width: fit-content;
    }
    .timeline-machine i { color: var(--color-secondary); font-size: 0.75rem; }

    /* FIX POUR LE SELECT DANS LA MODALE */
#schedule-modal .ss-main {
    background-color: white !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 6px !important;
    height: 40px !important;
    display: flex !important;
    align-items: center !important;
}
#schedule-modal .ss-content {
    z-index: 99999 !important; /* Passe au dessus de la modale */
}

    /* Marqueur avec Icône */
    .timeline-marker { 
        position: absolute; left: -12px; top: 0; 
        width: 26px; height: 26px; border-radius: 50%; 
        background: white; border: 2px solid var(--neutral-300);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.75rem; color: var(--neutral-500); z-index: 2;
        box-shadow: 0 0 0 3px white; /* Effet de détourage */
    }
    
    /* Couleurs des marqueurs selon le type */
    .timeline-item.type-report .timeline-marker { border-color: var(--color-primary); color: var(--color-primary); background: var(--color-primary-light); }
    .timeline-item.type-rdv .timeline-marker { border-color: var(--color-warning); color: var(--color-warning); background: #fffbeb; }

    /* Date au dessus de la carte */
    .timeline-date { 
        font-size: 0.75rem; font-weight: 700; color: var(--neutral-500); 
        margin-bottom: 0.5rem; display: block; text-transform: uppercase; letter-spacing: 0.05em;
    }

    /* Carte Contenu */
    .timeline-card { 
        background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem 1.25rem;
        box-shadow: var(--shadow-sm); transition: all 0.2s; position: relative;
    }
    .timeline-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--color-primary-light); }
    
    /* En-tête de la carte */
    .timeline-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .timeline-title { font-size: 0.95rem; font-weight: 700; color: var(--neutral-800); margin: 0; }
    
    .timeline-tag { 
        font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; font-weight: 600; text-transform: uppercase;
    }
    .tag-report { background: var(--neutral-100); color: var(--neutral-600); }
    .tag-rdv { background: #fff7ed; color: #c2410c; }

    .timeline-desc { font-size: 0.9rem; color: var(--neutral-600); line-height: 1.5; }

    /* Bouton PDF Flottant */
    /* MODIFICATION: Bouton Document (Nouveau Style) */
    .timeline-action { 
        margin-top: 1rem; padding-top: 0.75rem; border-top: 1px dashed var(--border-color-light); 
        display: flex; justify-content: flex-end;
    }
    
    .btn-doc-action {
        display: inline-flex; align-items: center; gap: 8px;
        background: white; 
        border: 1px solid var(--color-primary); 
        color: var(--color-primary);
        padding: 6px 14px; 
        border-radius: 20px; /* Style "Pill" */
        font-size: 0.85rem; font-weight: 600;
        cursor: pointer; transition: all 0.2s;
    }
    .btn-doc-action:hover {
        background: var(--color-primary-light);
        box-shadow: 0 2px 4px rgba(2, 119, 189, 0.15);
        transform: translateY(-1px);
    }
    .btn-doc-action i { font-size: 0.9rem; }
    .btn-pdf-link {
        color: var(--color-primary); font-size: 0.85rem; font-weight: 500; text-decoration: none; 
        display: flex; align-items: center; gap: 5px; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;
    }
    .btn-pdf-link:hover { background: var(--color-primary-light); }

/* Style pour le mode Planning Groupé */
.badge-canton {
    background: var(--neutral-800); color: white;
    padding: 2px 6px; border-radius: 4px; 
    font-weight: bold; font-size: 0.75rem; margin-right: 5px;
}

.planning-row { transition: background 0.2s; }
.planning-row:hover { background: var(--neutral-50); }

/* Animation simple pour l'accordéon */
.details-row.hidden { display: none; }
.details-row td { border-top: none !important; box-shadow: inset 0 6px 6px -6px rgba(0,0,0,0.1); }

/* --- FIX SLIMSELECT (VERSION PROPRE) --- */

/* 1. La barre fermée (dans la toolbar) */
.toolbar-filters-section .ss-main {
    background-color: white !important;
    border: 1px solid var(--border-color) !important;
    height: 38px !important;
    width: 160px !important; /* Largeur fixe */
    border-radius: 6px !important;
    padding: 0 10px !important;
    box-shadow: none !important;
    color: var(--neutral-700) !important;
    display: flex !important;
}

/* 2. Le texte à l'intérieur */
.ss-single {
    margin: 0 !important;
    font-size: 0.85rem !important;
    font-weight: 500 !important;
}

/* 3. Le Menu Déroulant (Flottant) */
.ss-content {
    width: 220px !important; /* Un peu plus large pour lire */
    z-index: 10000 !important; /* Passe DEVANT le tableau */
    border: 1px solid var(--border-color) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    margin-top: 4px !important;
}

/* 4. Les Options */
.ss-list .ss-option {
    padding: 8px 15px !important;
    font-size: 0.85rem !important;
    color: var(--neutral-800) !important; /* Texte bien noir */
    cursor: pointer !important;
}

.ss-list .ss-option:hover {
    background-color: var(--neutral-50) !important;
    color: var(--color-primary) !important;
}

/* 5. Masquer la recherche (Sécurité supplémentaire) */
.ss-search {
    display: none !important;
}
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header"><h2>KB Medizin</h2></div>
      <nav class="sidebar-nav">
        <a href="/dashboard.html"><i class="fas fa-chart-line"></i><span>Tableau de bord</span></a>
        <a href="/clients.html" class="active"><i class="fas fa-users"></i><span>Clients</span></a>
        <a href="/checklists.html"><i class="fas fa-clipboard-check"></i><span>Checklists</span></a>
        <a href="/reports.html"><i class="fas fa-file-alt"></i><span>Rapports</span></a>
        <a href="/stk.html"><i class="fas fa-file-signature"></i><span>STK</span></a>
        <a href="/admin.html" id="admin-link" class="hidden"><i class="fas fa-cog"></i><span>Administration</span></a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info" id="user-info"></div>
        <button class="btn btn-secondary btn-sm" id="logout-btn" style="width: 100%"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
      </div>
    </aside>

    <main class="main-content">
      
      <div class="page-header">
        <div class="header-title-group">
            <h1><i class="fas fa-building"></i> Répertoire Clients</h1>
        </div>
        <div class="header-actions-group" style="display: flex; gap: 10px;">
            <input type="file" id="import-excel-input" hidden accept=".xlsx, .xls" />
            
            <button class="btn btn-secondary" onclick="document.getElementById('import-excel-input').click()" title="Importer depuis Excel">
                <i class="fas fa-file-import"></i> Importer
            </button>

            <button class="btn btn-secondary" onclick="exportData()" title="Exporter en CSV">
                <i class="fas fa-file-export"></i> Exporter
            </button>
            <button class="btn btn-primary" onclick="openClientModal()">
                <i class="fas fa-plus"></i> Nouveau Client
            </button>
        </div>
      </div>

      <div class="client-container-fluid">
        
        <div class="toolbar-clean-bar">
            
            <div class="toolbar-search-section">
                <i class="fas fa-search"></i>
                <input type="text" id="global-search" placeholder="Rechercher un client, une ville..." />
            </div>

            <div class="toolbar-divider"></div>

            <div class="toolbar-nav-section">
                <button class="nav-text-btn active" onclick="switchView('directory')" id="tab-directory">
                    Annuaire
                </button>
                <button class="nav-text-btn" onclick="switchView('planning')" id="tab-planning">
                    Planning Services
                </button>
            </div>

            <div style="flex: 1;"></div> 
            
            <div class="toolbar-filters-section">
    <select id="filter-canton">
        <option value="">Canton (Tous)</option>
        <option value="AG">Argovie (AG)</option>
        <option value="AI">Appenzell Rh.-Int. (AI)</option>
        <option value="AR">Appenzell Rh.-Ext. (AR)</option>
        <option value="BE">Berne (BE)</option>
        <option value="BL">Bâle-Campagne (BL)</option>
        <option value="BS">Bâle-Ville (BS)</option>
        <option value="FR">Fribourg (FR)</option>
        <option value="GE">Genève (GE)</option>
        <option value="GL">Glaris (GL)</option>
        <option value="GR">Grisons (GR)</option>
        <option value="JU">Jura (JU)</option>
        <option value="LU">Lucerne (LU)</option>
        <option value="NE">Neuchâtel (NE)</option>
        <option value="NW">Nidwald (NW)</option>
        <option value="OW">Obwald (OW)</option>
        <option value="SG">Saint-Gall (SG)</option>
        <option value="SH">Schaffhouse (SH)</option>
        <option value="SO">Soleure (SO)</option>
        <option value="SZ">Schwytz (SZ)</option>
        <option value="TG">Thurgovie (TG)</option>
        <option value="TI">Tessin (TI)</option>
        <option value="UR">Uri (UR)</option>
        <option value="VD">Vaud (VD)</option>
        <option value="VS">Valais (VS)</option>
        <option value="ZG">Zoug (ZG)</option>
        <option value="ZH">Zurich (ZH)</option>
    </select>
    
    <select id="filter-sector">
        <option value="">Secteur (Tous)</option>
        <option value="ORL">ORL</option>
        <option value="Gynécologie">Gynécologie</option>
        <option value="Stérilisation">Stérilisation</option>
    </select>

    <button class="btn-icon-simple" id="toggle-advanced-filters" title="Filtres avancés">
        <i class="fas fa-sliders-h"></i>
    </button>
</div>
        </div>

        <div id="advanced-filters-panel" class="filters-panel hidden">
            <div class="filters-grid">
                <div class="form-group mb-0"><label>Marque</label><input type="text" id="adv-brand" placeholder="Ex: Atmos"></div>
                <div class="form-group mb-0"><label>Modèle</label><input type="text" id="adv-model" placeholder="Ex: C31"></div>
                <div class="form-group mb-0"><label>N° Série</label><input type="text" id="adv-serial" placeholder="S/N..."></div>
                <div class="form-group mb-0"><label>Statut</label><select id="adv-status"><option value="">Tous</option><option value="expired">Expiré</option><option value="warning">Bientôt</option><option value="ok">À jour</option></select></div>
            </div>
            <div class="filters-footer">
                <button class="btn-link-reset" id="clear-filters">Effacer les filtres</button>
            </div>
        </div>

        <div id="view-directory" class="view-content active">
            <div class="erp-table-wrapper">
                <table class="erp-table" id="clients-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="handleSort('cabinet_name')" style="width:25%;">Client / Cabinet <i class="fas fa-sort"></i></th>
                            <th class="sortable" onclick="handleSort('city')" style="width:15%;">Localisation <i class="fas fa-sort"></i></th>
                            <th style="width:20%;">Contact</th>
                            <th style="width:25%;">Parc Machine</th>
                            <th class="sortable" onclick="handleSort('appointment_at')" style="width:10%;">RDV <i class="fas fa-sort"></i></th>
                            <th style="width:60px;"></th>
                        </tr>
                    </thead>
                    <tbody id="clients-tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-planning" class="view-content">
    <div class="erp-table-wrapper planning-mode">
        <table class="erp-table planning-table" id="planning-table">
            <thead>
                <tr>
                    <th style="width: 50px;">État</th> <th style="width: 25%;">Client / Cabinet</th>
                    <th style="width: 15%;">Localisation</th>
                    <th style="width: 30%;">Synthèse Parc</th> <th style="width: 15%;">Prochaine Échéance</th>
                    <th style="text-align:right;">Actions</th>
                </tr>
            </thead>
            <tbody id="planning-tbody"></tbody>
        </table>
    </div>
</div>

        <div class="erp-pagination">
            <div id="pagination-info" style="font-size:0.85rem; color:var(--neutral-500);">Chargement...</div>
            <div class="pagination-controls" style="display: flex; gap: 5px;">
                <button class="pg-btn" id="prev-page"><i class="fas fa-chevron-left"></i></button>
                <button class="pg-btn" id="next-page"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="pagination-limit">
                <select id="limit-select" class="minimal-select" style="height:32px; padding:0 25px 0 10px;">
                    <option value="25">25 / page</option>
                    <option value="50">50 / page</option>
                    <option value="100">100 / page</option>
                </select>
            </div>
        </div>

      </div>
    </main>
  </div>

  <div class="modal" id="client-details-modal">
      <div class="modal-content client-sheet-modal">
          <div class="sheet-header">
              <div class="sheet-title-box">
                  <div class="sheet-icon-box"><i class="fas fa-hospital-user"></i></div>
                  <div>
                      <h2 id="sheet-name" style="margin:0; font-size:1.4rem;">Nom Cabinet</h2>
                      <div class="sheet-meta-tags">
                          <span id="sheet-category" class="meta-badge">SECTEUR</span>
                          <span class="meta-sep">•</span>
                          <span id="sheet-city-header">VILLE</span>
                      </div>
                  </div>
              </div>
              <div class="sheet-actions-row" style="display:flex; gap:10px;">
                  <button class="btn btn-secondary btn-sm" onclick="openClientModal(currentClientId)">
                      <i class="fas fa-pen"></i> Modifier
                  </button>
                  <button class="btn btn-danger btn-sm" onclick="openDeleteModal(currentClientId)">
                      <i class="fas fa-trash"></i>
                  </button>
                  <button class="modal-close" onclick="closeClientDetailsModal()">&times;</button>
              </div>
          </div>
          
          <div class="sheet-layout">
              <div class="sheet-sidebar">
                  <div class="info-group">
                      <label>COORDONNÉES</label>
                      <div class="info-line"><i class="fas fa-map-marker-alt"></i> <span id="sheet-address">-</span></div>
                      <div class="info-line"><i class="fas fa-phone"></i> <span id="sheet-phone">-</span></div>
                      <div class="info-line"><i class="fas fa-envelope"></i> <span id="sheet-email">-</span></div>
                      <div class="info-line"><i class="fas fa-user-md"></i> <strong id="sheet-contact">-</strong></div>
                  </div>
                  
                  <div class="info-group">
                      <label>GÉOLOCALISATION</label>
                      <div id="sheet-coords" class="geo-box">Non défini</div>
                  </div>

                  <div class="info-group">
                      <label>NOTES INTERNES</label>
                      <div id="sheet-notes" style="background:white; border:1px solid var(--border-color); padding:10px; border-radius:6px; font-style:italic; font-size:0.9rem; color:var(--neutral-500);">Aucune note.</div>
                  </div>
              </div>

              <div class="sheet-content">
                  <div class="sheet-tabs">
                      <button class="sheet-tab active" onclick="switchSheetTab('equipment')" id="btn-tab-equipment">Parc Machines <span class="badge-count" id="count-eq">0</span></button>
                      <button class="sheet-tab" onclick="switchSheetTab('history')" id="btn-tab-history">Historique <span class="badge-count" id="count-hist">0</span></button>
                  </div>
                  
                  <div id="tab-equipment" class="tab-pane active">
                      <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                          <h3 style="margin:0; font-size:1.1rem;">Équipements installés</h3>
                          <button class="btn btn-primary btn-sm" onclick="openEquipFormModal()">
                              <i class="fas fa-plus"></i> Ajouter
                          </button>
                      </div>
                      <div id="sheet-equipment-list" class="cards-grid"></div>
                  </div>

                  <div id="tab-history" class="tab-pane">
                      <div id="sheet-history-list" class="history-feed"></div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <div class="modal" id="client-modal">
      <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header"><h2><i class="fas fa-user-edit"></i> Édition Client</h2><button class="modal-close" onclick="closeClientModal()">&times;</button></div>
          <div class="modal-body">
              <form id="client-form">
                  <input type="hidden" id="client-id">
                  <div class="form-row">
                      <div class="form-group" style="flex:2"><label>Nom Cabinet *</label><input type="text" id="client-name" required></div>
                      <div class="form-group"><label>Secteur</label><select id="client-activity"><option value="ORL">ORL</option><option value="Gynécologie">Gynécologie</option><option value="Stérilisation">Stérilisation</option><option value="Autre">Autre</option></select></div>
                  </div>
                  <div class="form-row">
                      <div class="form-group"><label>Contact</label><input type="text" id="client-contact"></div>
                      <div class="form-group"><label>Téléphone</label><input type="text" id="client-phone"></div>
                      <div class="form-group"><label>Email</label><input type="email" id="client-email"></div>
                  </div>
                  <div class="form-group"><label>Adresse</label><input type="text" id="client-address" placeholder="Rue et numéro"></div>
                  <div class="form-row">
                      <div class="form-group"><label>NPA</label><input type="text" id="client-npa"></div>
                      <div class="form-group" style="flex:2"><label>Ville</label><input type="text" id="client-city"></div>
                      <div class="form-group"><label>Canton</label><input type="text" id="client-canton" style="text-transform:uppercase" maxlength="2"></div>
                  </div>
                  
                  <div class="gps-container" style="background:#f0fdf4; padding:12px; border-radius:8px; margin-bottom:1.5rem; border:1px solid #bbf7d0;">
                      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                          <label style="margin:0; font-size:0.8rem; font-weight:bold; color:#166534;">COORDONNÉES GPS</label>
                          <button type="button" id="btn-geo-search" class="btn btn-sm btn-success" style="padding:2px 8px; font-size:0.75rem;">Détecter</button>
                      </div>
                      <div class="form-row">
                          <div class="form-group mb-0"><input type="number" id="client-lat" step="0.0000001" placeholder="Latitude"></div>
                          <div class="form-group mb-0"><input type="number" id="client-lon" step="0.0000001" placeholder="Longitude"></div>
                      </div>
                      <div id="geo-status" style="font-size:0.75rem; margin-top:5px; min-height:1rem;"></div>
                  </div>

                  <div class="form-group"><label>Notes</label><textarea id="client-notes" rows="2"></textarea></div>
              </form>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" onclick="closeClientModal()">Annuler</button><button class="btn btn-primary" onclick="saveClient()">Enregistrer</button></div>
      </div>
  </div>

  <div class="modal" id="equipment-form-modal">
      <div class="modal-content" style="max-width:600px;">
          <div class="modal-header"><h2><i class="fas fa-server"></i> Machine</h2><button class="modal-close" onclick="closeEquipModal()">&times;</button></div>
          <div class="modal-body">
              <form id="equip-form">
                  <input type="hidden" id="equip-id">
                  <div class="form-group"><label>Modèle</label><select id="equip-select" required></select></div>
                  <div class="form-group">
        <label>Emplacement / Médecin</label>
        <input type="text" id="equip-location" placeholder="Ex: Salle 1, Dr. Müller...">
    </div>
                  <div class="form-group"><label>N° Série</label><input type="text" id="equip-serial"></div>
                  <div class="form-row">
                      <div class="form-group"><label>Installé le</label><input type="date" id="equip-install"></div>
                      <div class="form-group"><label>Dernière Maint.</label><input type="date" id="equip-last"></div>
                  </div>
                  <div class="form-group"><label>Intervalle (Années)</label><select id="equip-interval"><option value="1">1 An</option><option value="2">2 Ans</option><option value="3">3 Ans</option></select></div>
              </form>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" onclick="closeEquipModal()">Annuler</button><button class="btn btn-primary" onclick="saveEquipment()">Sauvegarder</button></div>
      </div>
  </div>

  <div class="modal" id="delete-modal"><div class="modal-content" style="max-width:400px"><div class="modal-header"><h2 class="text-danger">Confirmer</h2><button class="modal-close" onclick="closeDeleteModal()">&times;</button></div><div class="modal-body"><p>Voulez-vous vraiment supprimer cet élément définitivement ?</p></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeDeleteModal()">Non</button><button class="btn btn-danger" id="confirm-delete-btn">Oui, supprimer</button></div></div></div>
  
<div class="modal" id="schedule-modal">
    <div class="modal-content" style="max-width: 400px; overflow: visible;">
        <div class="modal-header">
            <h2><i class="fas fa-calendar-plus"></i> Planifier RDV</h2>
            <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow: visible;"> <input type="hidden" id="schedule-client-id">
            <p id="schedule-client-name" style="margin-bottom: 1.5rem; font-weight: 600; color: var(--neutral-700); font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 10px;"></p>
            
            <div class="form-group">
                <label>Date du rendez-vous</label>
                <input type="date" id="schedule-date" class="form-control" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label>Technicien(s) assigné(s)</label>
                <select id="schedule-tech" multiple style="width: 100%;">
                    </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeScheduleModal()">Annuler</button>
            <button class="btn btn-primary" onclick="confirmSchedule()">Valider le RDV</button>
        </div>
    </div>
</div>

  <div id="notification-container"></div>
  <script src="https://unpkg.com/slim-select@2.8.2/dist/slimselect.min.js"></script>
<script type="module" src="/js/init-selects.js"></script>
<script src="/js/loader.js"></script>
  <script src="/js/clients.js"></script>
</body>
</html>